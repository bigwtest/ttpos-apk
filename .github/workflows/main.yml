name: Build Windows Simple

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "选择构建分支"
        required: true
        type: choice
        options:
          - "main"
          - "new-test"
      package_name:
        description: "选择要构建的包"
        required: true
        type: choice
        options:
          - pos
          - kds
          - assistant
          - tablet
      base_url:
        description: "选择API基础URL"
        required: true
        type: choice
        options:
          - "https://ttpos-test1.ttpos.com/api/v1"
          - "https://api.ttpos.com/api/v1"
          - "https://ttpos-pro.keli.vip/api/v1"
      base_ws_url:
        description: "选择WebSocket基础URL"
        required: true
        type: choice
        options:
          - "wss://ttpos-test1.ttpos.com/ws"
          - "wss://api.ttpos.com/ws"
          - "wss://ttpos-pro.keli.vip/ws"

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.3'
          channel: 'stable'

      - name: Install Melos
        run: |
          flutter --version
          dart pub global activate melos

      - name: Melos init config
        env:
          PUB_HOSTED_URL: https://pub.flutter-io.cn
          FLUTTER_STORAGE_BASE_URL: https://storage.flutter-io.cn
        run: |
          melos run init
          melos bs

      - name: Config API_BASE_URL
        shell: pwsh
        run: |
          Write-Host "配置环境变量..."
          Write-Host "base_url: ${{ github.event.inputs.base_url }}"
          Write-Host "base_ws_url: ${{ github.event.inputs.base_ws_url }}"
          
          # 设置环境变量
          $env:API_BASE_URL = "${{ github.event.inputs.base_url }}"
          $env:WS_BASE_URL = "${{ github.event.inputs.base_ws_url }}"
          
          # 更新 .env 文件
          $envFile = "apps/${{ github.event.inputs.package_name }}/.env.production.local"
          Write-Host "更新环境文件: $envFile"
          
          # 读取文件内容
          $lines = Get-Content $envFile
          $newLines = @()
          
          # 处理每一行
          foreach ($line in $lines) {
            if ($line -match '^API_BASE_URL=') {
              $newLines += "API_BASE_URL=$env:API_BASE_URL"
            }
            elseif ($line -match '^WS_BASE_URL=') {
              $newLines += "WS_BASE_URL=$env:WS_BASE_URL"
            }
            else {
              $newLines += $line
            }
          }
          
          # 写入新内容
          $newLines | Set-Content $envFile -Encoding UTF8
          
          Write-Host "环境文件内容:"
          Get-Content $envFile

      - name: Build Windows
        shell: pwsh
        run: |
          # 设置项目根目录
          $rootDir = $PWD
          Write-Host "项目根目录: $rootDir"
          
          # 进入应用目录
          $appDir = Join-Path $rootDir "apps\${{ github.event.inputs.package_name }}"
          Set-Location $appDir
          Write-Host "当前应用目录: $PWD"
          
          # 重新生成 Windows 项目
          Write-Host "重新生成 Windows 项目..."
          flutter create . --platforms=windows
          
          # 修复 flutter_tts 插件的 CMakeLists.txt
          $ttsCmakeFile = "windows\flutter\ephemeral\.plugin_symlinks\flutter_tts\windows\CMakeLists.txt"
          if (Test-Path $ttsCmakeFile) {
            Write-Host "修复 flutter_tts CMakeLists.txt 文件"
            $content = Get-Content $ttsCmakeFile -Raw
            $oldCommand = "execute_process(`n  COMMAND `${CMAKE_CURRENT_SOURCE_DIR}/nuget.exe install -OutputDirectory `${CMAKE_CURRENT_SOURCE_DIR}/packages Microsoft.Windows.CppWinRT -Version 2.0.210312.4`n)`n    ARGS install `"Microsoft.Windows.CppWinRT`" -Version 	2.0.210503.1 -ExcludeVersion -OutputDirectory `${CMAKE_BINARY_DIR}/packages)"
            $newCommand = "execute_process(`n  COMMAND `${NUGET_EXE} install `"Microsoft.Windows.CppWinRT`" -Version 2.0.210503.1 -ExcludeVersion -OutputDirectory `"${CMAKE_BINARY_DIR}/packages`"`n  WORKING_DIRECTORY `${CMAKE_CURRENT_SOURCE_DIR}`n  RESULT_VARIABLE NUGET_RESULT`n  OUTPUT_STRIP_TRAILING_WHITESPACE`n  ERROR_QUIET`n)"
            $content = $content.Replace($oldCommand, $newCommand)
            $content | Set-Content $ttsCmakeFile -Encoding UTF8
          }
          
          # 设置 C++ 版本
          $cmakeFile = "windows\CMakeLists.txt"
          if (Test-Path $cmakeFile) {
            Write-Host "设置 C++ 版本..."
            $content = Get-Content $cmakeFile -Raw
            # 在 project 命令后添加 C++ 版本设置
            $content = $content -replace "(project\(.*?\))", "`$1`nset(CMAKE_CXX_STANDARD 17)`nset(CMAKE_CXX_STANDARD_REQUIRED ON)"
            $content | Set-Content $cmakeFile -Encoding UTF8
          }
          
          # 执行构建脚本
          $scriptPath = Join-Path $rootDir "scripts\build_win.ps1"
          Write-Host "开始执行构建脚本: $scriptPath"
          
          # 设置环境变量
          $env:MELOS_PACKAGE_NAME = "${{ github.event.inputs.package_name }}"
          Write-Host "包名: $env:MELOS_PACKAGE_NAME"
          
          # 执行构建脚本
          & $scriptPath
          
          # 检查构建结果
          $releaseDir = Join-Path $rootDir "releases\${{ github.event.inputs.package_name }}\$env:MELOS_PACKAGE_VERSION"
          Write-Host "构建完成，发布目录内容:"
          Get-ChildItem -Path $releaseDir 
