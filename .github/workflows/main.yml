name: Build Windows Simple

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "选择构建分支"
        required: true
        type: choice
        options:
          - "main"
          - "new-test"
      package_name:
        description: "选择要构建的包"
        required: true
        type: choice
        options:
          - pos
          - kds
          - assistant
          - tablet
      base_url:
        description: "选择API基础URL"
        required: true
        type: choice
        options:
          - "https://ttpos-test1.ttpos.com/api/v1"
          - "https://api.ttpos.com/api/v1"
          - "https://ttpos-pro.keli.vip/api/v1"
      base_ws_url:
        description: "选择WebSocket基础URL"
        required: true
        type: choice
        options:
          - "wss://ttpos-test1.ttpos.com/ws"
          - "wss://api.ttpos.com/ws"
          - "wss://ttpos-pro.keli.vip/ws"

env:
  FLUTTER_VERSION: "3.27.3"
  ANDROID_FLUTTER_VERSION: "3.24.5"
  FLUTTER_ELINUX_VERSION: "3.16.9"
  PUB_HOSTED_URL: "https://pub.flutter-io.cn"
  FLUTTER_STORAGE_BASE_URL: "https://storage.flutter-io.cn"

jobs:
  build:
    runs-on: ${{ matrix.job.os }}
    strategy:
      fail-fast: false
      matrix:
        job:
          - {
              target: x86_64-pc-windows-msvc,
              os: windows-2022,
              arch: x86_64,
              vcpkg-triplet: x64-windows-static,
            }
    steps:
      - name: Checkout the code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          submodules: recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2.12.0
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'

      - name: Install Melos
        run: |
          flutter --version
          dart pub global activate melos

      - name: Melos init config
        env:
          PUB_HOSTED_URL: ${{ env.PUB_HOSTED_URL }}
          FLUTTER_STORAGE_BASE_URL: ${{ env.FLUTTER_STORAGE_BASE_URL }}
        run: |
          melos run init
          melos bs

      - name: Config API_BASE_URL
        shell: pwsh
        run: |
          Write-Host "配置环境变量..."
          Write-Host "base_url: ${{ github.event.inputs.base_url }}"
          Write-Host "base_ws_url: ${{ github.event.inputs.base_ws_url }}"
          
          # 设置环境变量
          $env:API_BASE_URL = "${{ github.event.inputs.base_url }}"
          $env:WS_BASE_URL = "${{ github.event.inputs.base_ws_url }}"
          
          # 更新 .env 文件
          $envFile = "apps/${{ github.event.inputs.package_name }}/.env.production.local"
          Write-Host "更新环境文件: $envFile"
          
          # 读取文件内容
          $lines = Get-Content $envFile
          $newLines = @()
          
          # 处理每一行
          foreach ($line in $lines) {
            if ($line -match '^API_BASE_URL=') {
              $newLines += "API_BASE_URL=$env:API_BASE_URL"
            }
            elseif ($line -match '^WS_BASE_URL=') {
              $newLines += "WS_BASE_URL=$env:WS_BASE_URL"
            }
            else {
              $newLines += $line
            }
          }
          
          # 写入新内容
          $newLines | Set-Content $envFile -Encoding UTF8
          
          Write-Host "环境文件内容:"
          Get-Content $envFile

      - name: Build Windows
        shell: pwsh
        run: |
          # 设置项目根目录
          $rootDir = $PWD
          Write-Host "项目根目录: $rootDir"
          
          # 进入应用目录
          $appDir = Join-Path $rootDir "apps\${{ github.event.inputs.package_name }}"
          Set-Location $appDir
          Write-Host "当前应用目录: $PWD"
          
          # 执行构建脚本
          $scriptPath = Join-Path $rootDir "scripts\build_win.ps1"
          Write-Host "开始执行构建脚本: $scriptPath"
          
          # 设置环境变量
          $env:MELOS_PACKAGE_NAME = "${{ github.event.inputs.package_name }}"
          Write-Host "包名: $env:MELOS_PACKAGE_NAME"
          
          # 执行构建脚本
          & $scriptPath
          
          # 检查构建结果
          $releaseDir = Join-Path $rootDir "releases\${{ github.event.inputs.package_name }}\$env:MELOS_PACKAGE_VERSION"
          Write-Host "构建完成，发布目录内容:"
          Get-ChildItem -Path $releaseDir 
