name: Build Android APK

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0'
          channel: 'stable'
          
      - name: Install dependencies
        shell: pwsh
        run: |
          flutter pub get
          flutter pub global activate melos
          melos bootstrap
          
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          
      - name: Build APKs
        shell: pwsh
        run: |
          # 定义要构建的应用列表
          $apps = @("pos", "assistant", "tablet", "kds")
          
          foreach ($app in $apps) {
            Write-Host "正在构建 $app 应用..."
            
            # 切换到应用目录
            Set-Location "apps/$app"
            
            # 获取版本号
            $version = (Get-Content pubspec.yaml | Select-String -Pattern "version:").ToString().Split(":")[1].Trim()
            Write-Host "当前应用 $app 的版本号: $version"
            
            # 设置环境变量
            $env:MELOS_PACKAGE_NAME = $app
            $env:MELOS_PACKAGE_VERSION = $version
            
            # 构建 APK
            flutter build apk --release
            
            # 创建发布目录
            New-Item -Path "../../releases/$app/$version" -ItemType Directory -Force
            
            # 复制 APK 到发布目录
            $app_name = switch ($app) {
              "pos" { "TTPOS" }
              "kds" { "TTPOS-Kitchen" }
              "assistant" { "TTPOS-Go" }
              "tablet" { "TTPOS-Menu" }
              default { $app }
            }
            
            Copy-Item -Path "build/app/outputs/flutter-apk/app-release.apk" -Destination "../../releases/$app/$version/$app_name-$version.apk"
            
            # 返回项目根目录
            Set-Location "../.."
          }
          
      # - name: Create Release ZIP
      #   shell: pwsh
      #   run: |
      #     # 创建临时目录
      #     $tempDir = Join-Path $PWD "temp_for_zip"
      #     if (Test-Path $tempDir) {
      #       Remove-Item -Path $tempDir -Recurse -Force
      #     }
      #     New-Item -Path $tempDir -ItemType Directory -Force
          
      #     # 复制所有 APK 到临时目录
      #     foreach ($app in @("pos", "assistant", "tablet", "kds")) {
      #       $version = (Get-Content "apps/$app/pubspec.yaml" | Select-String -Pattern "version:").ToString().Split(":")[1].Trim()
      #       $app_name = switch ($app) {
      #         "pos" { "TTPOS" }
      #         "kds" { "TTPOS-Kitchen" }
      #         "assistant" { "TTPOS-Go" }
      #         "tablet" { "TTPOS-Menu" }
      #         default { $app }
      #       }
            
      #       Copy-Item -Path "releases/$app/$version/$app_name-$version.apk" -Destination $tempDir
      #     }
          
      #     # 创建 ZIP 文件
      #     Compress-Archive -Path "$tempDir\*" -DestinationPath "android-$version.zip" -Force
          
      #     # 清理临时目录
      #     Remove-Item -Path $tempDir -Recurse -Force
          
      # - name: Upload Release Assets
      #   uses: softprops/action-gh-release@v1
      #   if: startsWith(github.ref, 'refs/tags/')
      #   with:
      #     files: |
      #       android-*.zip
      #       releases/**/*.apk
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
