name: Build TTPOS macOS App

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'ç›®æ ‡ä»“åº“åœ°å€ (æ ¼å¼: owner/repo)'
        required: true
        default: 'innet8/ttpos-flutter'
        type: string
      build_type:
        description: "é€‰æ‹©æž„å»ºç±»åž‹"
        required: true
        type: choice
        options:
          - single
          - all
        default: single
      branch:
        description: "é€‰æ‹©æž„å»ºåˆ†æ”¯"
        required: true
        type: choice
        options:
          - release
          - new-test
          - xq_tts
      env:
        description: "é€‰æ‹©æž„å»ºçŽ¯å¢ƒ"
        required: true
        type: choice
        options:
          - prod
          - test
          - dev
        default: prod
      package_name:
        description: "é€‰æ‹©è¦æž„å»ºçš„åº”ç”¨ç«¯"
        required: true
        type: choice
        options:
          - pos
          - assistant
          - kds
          - tablet
          - shop
        default: pos
      base_url:
        description: "é€‰æ‹© API åŸºç¡€ URL"
        required: true
        type: choice
        options:
          - https://ttpos-test1.ttpos.com/api/v1
          - https://api.ttpos.com/api/v1
          - https://ttpos-pro.keli.vip/api/v1
      base_ws_url:
        description: "é€‰æ‹© WebSocket åŸºç¡€ URL"
        required: true
        type: choice
        options:
          - wss://ttpos-test1.ttpos.com/ws
          - wss://api.ttpos.com/ws
          - wss://ttpos-pro.keli.vip/ws
      upload_to_storage:
        description: "æ˜¯å¦ä¸Šä¼ åˆ°å­˜å‚¨æ¡¶"
        required: false
        default: true
        type: boolean
      upload_to_web:
        description: "æ˜¯å¦ä¸Šä¼ åˆ° web æœåŠ¡å™¨"
        required: false
        default: true
        type: boolean

jobs:
  build-single:
    if: github.event.inputs.build_type == 'single'
    runs-on: macos-latest
    env:
      PACKAGE_NAME: ${{ github.event.inputs.package_name }}
      BUILD_ENV: ${{ github.event.inputs.env }}
      BRANCH_NAME: ${{ github.event.inputs.branch }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      MAC_KEYCHAIN_PASSWORD: ${{ secrets.MAC_KEYCHAIN_PASSWORD }}
      UPLOAD_TO_STORAGE: ${{ github.event.inputs.upload_to_storage }}
      UPLOAD_TO_WEB: ${{ github.event.inputs.upload_to_web }}
      # å­˜å‚¨æ¡¶è·¯å¾„
      assistant_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Assistant/' || 'dc_apk/TTPOS/Test/MacOS/Assistant/' }}
      kds_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Kitchen/' || 'dc_apk/TTPOS/Test/MacOS/Kitchen/' }}
      tablet_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Menu/' || 'dc_apk/TTPOS/Test/MacOS/Menu/' }}
      pos_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Cashier/' || 'dc_apk/TTPOS/Test/MacOS/Cashier/' }}
      shop_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Shop/' || 'dc_apk/TTPOS/Test/MacOS/Shop/' }}
      # ä¸­è½¬æœåŠ¡å™¨è·¯å¾„
      scp_s_assistant: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/assistant/' || '/hitosea/ttpos-apk/Test/assistant/' }}
      scp_s_kds: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/kds/' || '/hitosea/ttpos-apk/Test/kds/' }}
      scp_s_tablet: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/tablet/' || '/hitosea/ttpos-apk/Test/tablet/' }}
      scp_s_pos: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/pos/' || '/hitosea/ttpos-apk/Test/pos/' }}
      scp_s_shop: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/shop/' || '/hitosea/ttpos-apk/Test/shop/' }}
      # æœ€ç»ˆä¸‹è½½è·¯å¾„ï¼šwww.ttpos.com/downloads
      scp_d_assistant: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Assistant/' || '/root/web/web/restant/out/downloads/MacOS/Assistant/' }}
      scp_d_kds: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Kitchen/' || '/root/web/web/restant/out/downloads/MacOS/Kitchen/' }}
      scp_d_tablet: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Menu/' || '/root/web/web/restant/out/downloads/MacOS/Menu/' }}
      scp_d_pos: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Cashier/' || '/root/web/web/restant/out/downloads/MacOS/Cashier/' }}
      scp_d_shop: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Shop/' || '/root/web/web/restant/out/downloads/MacOS/Shop/' }}
    steps: &mac_steps
      - name: æ˜¾ç¤ºæž„å»ºä¿¡æ¯
        shell: bash
        run: |
          echo "========================================="
          echo "macOS æž„å»ºä¿¡æ¯"
          echo "========================================="
          echo "åº”ç”¨ç«¯: $PACKAGE_NAME"
          echo "åˆ†æ”¯: $BRANCH_NAME"
          echo "çŽ¯å¢ƒ: $BUILD_ENV"
          echo "API URL: ${{ github.event.inputs.base_url }}"
          echo "WebSocket URL: ${{ github.event.inputs.base_ws_url }}"
          echo "========================================="

      - name: Checkout the code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repository }}
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.TOKEN }}

      - name: é…ç½® App Store Connect ç™»å½•
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          if [ -z "${APPLE_ID}" ] || [ -z "${APPLE_APP_SPECIFIC_PASSWORD}" ] || [ -z "${APPLE_TEAM_ID}" ]; then
            echo "ç¼ºå°‘ App Store Connect ç™»å½•æ‰€éœ€å‡­æ®ï¼Œè·³è¿‡ç™»å½•"
            exit 0
          fi
          echo "LOGGED_IN_WITH_APPLE_ID=true" >> "$GITHUB_ENV"

      - name: åˆ›å»ºä¸´æ—¶é’¥åŒ™ä¸²å¹¶å¯¼å…¥è¯ä¹¦
        shell: bash
        env:
          MAC_SIGNING_CERT_BASE64: ${{ secrets.MAC_SIGNING_CERT_BASE64 }}
          MAC_SIGNING_CERT_PASSWORD: ${{ secrets.MAC_SIGNING_CERT_PASSWORD }}
          MAC_KEYCHAIN_PASSWORD: ${{ secrets.MAC_KEYCHAIN_PASSWORD || 'github-actions-secure-2024' }}
        run: |
          set -euo pipefail
          
          # æ£€æŸ¥å¿…è¦çš„ Secrets
          if [ -z "${MAC_SIGNING_CERT_BASE64}" ] || [ -z "${MAC_SIGNING_CERT_PASSWORD}" ]; then
            echo "é”™è¯¯: ç¼ºå°‘å¿…è¦çš„è¯ä¹¦ Secrets"
            echo "è¯·ç¡®ä¿é…ç½®äº†ä»¥ä¸‹ Secrets:"
            echo "- MAC_SIGNING_CERT_BASE64: .p12 è¯ä¹¦çš„ Base64 ç¼–ç "
            echo "- MAC_SIGNING_CERT_PASSWORD: .p12 è¯ä¹¦çš„å¯†ç "
            exit 1
          fi
          
          # åˆ›å»ºä¸´æ—¶é’¥åŒ™ä¸²
          KEYCHAIN_PASSWORD="${MAC_KEYCHAIN_PASSWORD}"
          KEYCHAIN_PATH="$RUNNER_TEMP/mac-signing.keychain-db"
          
          echo "åˆ›å»ºä¸´æ—¶é’¥åŒ™ä¸²: $KEYCHAIN_PATH"
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # è®¾ç½®é’¥åŒ™ä¸²åˆ—è¡¨
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          # å¯¼å…¥è¯ä¹¦
          CERT_PATH="$RUNNER_TEMP/developer_id_cert.p12"
          echo "è§£ç å¹¶å¯¼å…¥è¯ä¹¦..."
          echo "$MAC_SIGNING_CERT_BASE64" | base64 --decode > "$CERT_PATH"
          
          # å¯¼å…¥è¯ä¹¦åˆ°é’¥åŒ™ä¸²
          security import "$CERT_PATH" -P "$MAC_SIGNING_CERT_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          
          # è®¾ç½®é’¥åŒ™ä¸²åˆ†åŒºåˆ—è¡¨
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # éªŒè¯è¯ä¹¦å¯¼å…¥
          echo "éªŒè¯å¯¼å…¥çš„è¯ä¹¦:"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"
          echo "MAC_KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> "$GITHUB_ENV"
          
          echo "è¯ä¹¦å¯¼å…¥å®Œæˆ!"

      - name: å®‰è£…å¼€å‘æè¿°æ–‡ä»¶
        shell: bash
        env:
          MAC_POS_PROFILE_BASE64: ${{ secrets.MAC_POS_PROFILE_BASE64 }}
          MAC_ASSISTANT_PROFILE_BASE64: ${{ secrets.MAC_ASSISTANT_PROFILE_BASE64 }}
          MAC_KDS_PROFILE_BASE64: ${{ secrets.MAC_KDS_PROFILE_BASE64 }}
          MAC_TABLET_PROFILE_BASE64: ${{ secrets.MAC_TABLET_PROFILE_BASE64 }}
          MAC_SHOP_PROFILE_BASE64: ${{ secrets.MAC_SHOP_PROFILE_BASE64 }}
        run: |
          set -e
          echo "ðŸ”§ å¼€å§‹å®‰è£… macOS å¼€å‘æè¿°æ–‡ä»¶..."
          echo "å½“å‰ PACKAGE_NAME=${PACKAGE_NAME}"

          PROFILE_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILE_DIR"

          if [ "$PACKAGE_NAME" = "all" ]; then
            echo "ðŸš€ æž„å»ºæ¨¡å¼ä¸º allï¼Œå¼€å§‹å®‰è£…æ‰€æœ‰åº”ç”¨çš„æè¿°æ–‡ä»¶..."
            for pkg in pos assistant kds tablet shop; do
              VAR_NAME="MAC_${pkg^^}_PROFILE_BASE64"
              PROFILE_VALUE="${!VAR_NAME}"

              if [ -z "$PROFILE_VALUE" ]; then
                echo "âš ï¸ æœªé…ç½® $VAR_NAMEï¼Œè·³è¿‡ $pkg"
                continue
              fi

              PROFILE_PATH="$RUNNER_TEMP/mac_${pkg}_profile.provisionprofile"
              PLIST_PATH="$RUNNER_TEMP/mac_${pkg}_profile.plist"

              echo "$PROFILE_VALUE" | base64 --decode > "$PROFILE_PATH"
              security cms -D -i "$PROFILE_PATH" > "$PLIST_PATH"

              PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" "$PLIST_PATH" 2>/dev/null || true)
              if [ -z "$PROFILE_UUID" ]; then
                echo "âŒ æ— æ³•è§£æž $pkg çš„æè¿°æ–‡ä»¶ UUIDï¼Œå¯èƒ½æ–‡ä»¶æŸå"
                continue
              fi

              cp "$PROFILE_PATH" "$PROFILE_DIR/${PROFILE_UUID}.provisionprofile"
              echo "âœ… å·²å®‰è£… $pkg çš„æè¿°æ–‡ä»¶ (${PROFILE_UUID})"
            done
          else
            case "${PACKAGE_NAME}" in
              pos)
                ERR_PROFILE_VAR="MAC_POS_PROFILE_BASE64"
                MAC_DEV_PROFILE_BASE64="${MAC_POS_PROFILE_BASE64}"
                ;;
              assistant)
                ERR_PROFILE_VAR="MAC_ASSISTANT_PROFILE_BASE64"
                MAC_DEV_PROFILE_BASE64="${MAC_ASSISTANT_PROFILE_BASE64}"
                ;;
              kds)
                ERR_PROFILE_VAR="MAC_KDS_PROFILE_BASE64"
                MAC_DEV_PROFILE_BASE64="${MAC_KDS_PROFILE_BASE64}"
                ;;
              tablet)
                ERR_PROFILE_VAR="MAC_TABLET_PROFILE_BASE64"
                MAC_DEV_PROFILE_BASE64="${MAC_TABLET_PROFILE_BASE64}"
                ;;
              shop)
                ERR_PROFILE_VAR="MAC_SHOP_PROFILE_BASE64"
                MAC_DEV_PROFILE_BASE64="${MAC_SHOP_PROFILE_BASE64}"
                ;;
              *)
                echo "æœªçŸ¥çš„åŒ…å: ${PACKAGE_NAME}ï¼Œè·³è¿‡æè¿°æ–‡ä»¶å®‰è£…"
                exit 0
                ;;
            esac

            if [ -z "${MAC_DEV_PROFILE_BASE64}" ]; then
              echo "æœªé…ç½® ${ERR_PROFILE_VAR} æè¿°æ–‡ä»¶ï¼Œè·³è¿‡å®‰è£…"
              exit 0
            fi

            PROFILE_PATH="$RUNNER_TEMP/mac_${PACKAGE_NAME}_profile.provisionprofile"
            PLIST_PATH="$RUNNER_TEMP/mac_${PACKAGE_NAME}_profile.plist"

            echo "$MAC_DEV_PROFILE_BASE64" | base64 --decode > "$PROFILE_PATH"
            security cms -D -i "$PROFILE_PATH" > "$PLIST_PATH"

            PROFILE_UUID=$(/usr/libexec/PlistBuddy -c "Print UUID" "$PLIST_PATH" 2>/dev/null || true)
            if [ -z "$PROFILE_UUID" ]; then
              echo "âŒ æ— æ³•è§£æžæè¿°æ–‡ä»¶ UUIDï¼Œæ–‡ä»¶å¯èƒ½æŸå"
              exit 1
            fi

            cp "$PROFILE_PATH" "$PROFILE_DIR/${PROFILE_UUID}.provisionprofile"
            echo "âœ… å·²å®‰è£… ${PACKAGE_NAME} çš„æè¿°æ–‡ä»¶ (${PROFILE_UUID})"
          fi

          echo "ðŸ“ å½“å‰å·²å®‰è£…çš„æè¿°æ–‡ä»¶ï¼š"
          ls -l "$PROFILE_DIR" || echo "(æœªæ£€æµ‹åˆ°ä»»ä½•æ–‡ä»¶)"

      - name: è®¾ç½®é»˜è®¤é’¥åŒ™ä¸²
        shell: bash
        run: |
          if [ -z "${KEYCHAIN_PATH:-}" ]; then
            echo "ç¼ºå°‘ KEYCHAIN_PATH" >&2
            exit 1
          fi
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "${MAC_KEYCHAIN_PASSWORD:-github-actions-secure-2024}" "$KEYCHAIN_PATH"


      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.3"
          channel: stable
          cache: true

      - name: Enable macOS desktop
        shell: bash
        run: flutter config --enable-macos-desktop

      - name: Precache Flutter artifacts
        shell: bash
        run: flutter precache --macos

      - name: Install Melos
        shell: bash
        run: |
          dart --version
          dart pub global activate melos
          echo "${HOME}/.pub-cache/bin" >> "$GITHUB_PATH"

      - name: Melos Init
        env:
          PUB_HOSTED_URL: https://pub.flutter-io.cn
          FLUTTER_STORAGE_BASE_URL: https://storage.flutter-io.cn
        shell: bash
        run: |
          melos run init
          melos bs

      - name: æ›´æ–°çŽ¯å¢ƒå˜é‡æ–‡ä»¶
        shell: bash
        run: |
          sed -i '' 's|^API_BASE_URL=.*|API_BASE_URL=${{ github.event.inputs.base_url }}|' apps/assistant/.env.production.local apps/kds/.env.production.local apps/pos/.env.production.local apps/tablet/.env.production.local apps/shop/.env.production.local
          sed -i '' 's|^WS_BASE_URL=.*|WS_BASE_URL=${{ github.event.inputs.base_ws_url }}|' apps/assistant/.env.production.local apps/kds/.env.production.local apps/pos/.env.production.local apps/tablet/.env.production.local apps/shop/.env.production.local
          echo "æ›´æ–°åŽçš„çŽ¯å¢ƒæ–‡ä»¶å†…å®¹:";
          cat ./apps/assistant/.env.production.local

      - name: è®¾ç½®æž„å»ºçŽ¯å¢ƒå˜é‡
        id: build_meta
        shell: bash
        run: |
          VERSION=$(grep '^version:' -m1 "apps/${PACKAGE_NAME}/pubspec.yaml" | awk '{print $2}' | cut -d'+' -f1)
          if [ -z "$VERSION" ]; then
            echo "æ— æ³•è§£æžç‰ˆæœ¬å·" >&2
            exit 1
          fi
          echo "MELOS_PACKAGE_NAME=${PACKAGE_NAME}" >> "$GITHUB_ENV"
          echo "MELOS_PACKAGE_VERSION=${VERSION}" >> "$GITHUB_ENV"
          case "$PACKAGE_NAME" in
            pos) APP_NAME="TTPOS" ;;
            assistant) APP_NAME="TTPOS-Go" ;;
            kds) APP_NAME="TTPOS-Kitchen" ;;
            tablet) APP_NAME="TTPOS-Menu" ;;
            shop) APP_NAME="TTPOS-Shop" ;;
            *) echo "ä¸æ”¯æŒçš„åŒ…: $PACKAGE_NAME" >&2; exit 1 ;;
          esac
          echo "APP_DISPLAY_NAME=${APP_NAME}" >> "$GITHUB_ENV"
          echo "Cashier_name=TTPOS-V${VERSION}.dmg" >> $GITHUB_ENV
          echo "Assistant_name=TTPOS-Go-V${VERSION}.dmg" >> $GITHUB_ENV
          echo "Kitchen_name=TTPOS-Kitchen-V${VERSION}.dmg" >> $GITHUB_ENV
          echo "Menu_name=TTPOS-Menu-V${VERSION}.dmg" >> $GITHUB_ENV
          echo "Shop_name=TTPOS-Shop-V${VERSION}.dmg" >> $GITHUB_ENV
          # æ ¹æ® matrix åˆ¤æ–­åŒ…åå’Œå¯¹åº”çš„è½¯é“¾å
            case "${{ env.PACKAGE_NAME }}" in
                "pos")
                    LATEST_NAME="TTPOS-latest.dmg"
                    VERSION_DMG="${{ env.Cashier_name }}"
                    echo ${LATEST_NAME} >> $GITHUB_ENV
                    echo ${VERSION_DMG} >> $GITHUB_ENV
                    ;;
                "assistant")
                    LATEST_NAME="TTPOS-Go-latest.dmg"
                    VERSION_DMG="${{ env.Assistant_name }}"
                    echo ${LATEST_NAME} >> $GITHUB_ENV
                    echo ${VERSION_DMG} >> $GITHUB_ENV
                    ;;
                "kds")
                    LATEST_NAME="TTPOS-Kitchen-latest.dmg"
                    VERSION_DMG="${{ env.Kitchen_name }}"
                    echo ${LATEST_NAME} >> $GITHUB_ENV
                    echo ${VERSION_DMG} >> $GITHUB_ENV
                    ;;
                "tablet")
                    LATEST_NAME="TTPOS-Menu-latest.dmg"
                    VERSION_DMG="${{ env.Menu_name }}"
                    echo ${LATEST_NAME} >> $GITHUB_ENV
                    echo ${VERSION_DMG} >> $GITHUB_ENV
                    ;;
                "shop")
                    LATEST_NAME="TTPOS-Shop-latest.dmg"
                    VERSION_DMG="${{ env.Shop_name }}"
                    echo ${LATEST_NAME} >> $GITHUB_ENV
                    echo ${VERSION_DMG} >> $GITHUB_ENV
                    ;;
            esac
          echo "è§£æžåˆ°ç‰ˆæœ¬å·: $VERSION"

      - name: èŽ·å–ç­¾åèº«ä»½
        shell: bash
        env:
          MAC_SIGNING_IDENTITY_SECRET: ${{ secrets.MAC_SIGNING_IDENTITY }}
          MAC_SIGNING_TEAM_ID_SECRET: ${{ secrets.MAC_SIGNING_TEAM_ID }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
        run: |
          set -euo pipefail
          
          # èŽ·å–å®žé™…çš„ç­¾åèº«ä»½
          echo "èŽ·å–å¯ç”¨çš„ç­¾åèº«ä»½..."
          AVAILABLE_IDENTITIES=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Developer ID Application" | head -1)
          if [ -z "$AVAILABLE_IDENTITIES" ]; then
            echo "é”™è¯¯: åœ¨é’¥åŒ™ä¸²ä¸­æœªæ‰¾åˆ° Developer ID Application è¯ä¹¦" >&2
            echo "å¯ç”¨çš„è¯ä¹¦åˆ—è¡¨:"
            security find-identity -v -p codesigning "$KEYCHAIN_PATH"
            exit 1
          fi
          
          # æå–ç­¾åèº«ä»½åç§°
          SIGNING_IDENTITY=$(echo "$AVAILABLE_IDENTITIES" | sed 's/.*"\(.*\)".*/\1/')
          TEAM_ID="${MAC_SIGNING_TEAM_ID_SECRET:-N278MM4R33}"
          
          echo "ä½¿ç”¨ç­¾åèº«ä»½: $SIGNING_IDENTITY"
          echo "ä½¿ç”¨å›¢é˜Ÿ ID: $TEAM_ID"
          
          # è®¾ç½®çŽ¯å¢ƒå˜é‡
          echo "MAC_SIGNING_IDENTITY=$SIGNING_IDENTITY" >> "$GITHUB_ENV"
          echo "MAC_SIGNING_TEAM_ID=$TEAM_ID" >> "$GITHUB_ENV"


      - name: æž„å»º macOS åº”ç”¨ï¼ˆå•åŒ…ï¼‰
        shell: bash
        env:
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
          APPLE_TEAM_ID: ${{ env.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          if [ -z "${KEYCHAIN_PATH}" ]; then
            echo "ç¼ºå°‘ KEYCHAIN_PATH çŽ¯å¢ƒå˜é‡" >&2
            exit 1
          fi
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "${MAC_KEYCHAIN_PASSWORD:-github-actions}" "$KEYCHAIN_PATH"
          echo "æž„å»ºå•ä¸ªåº”ç”¨: $PACKAGE_NAME"
          dart run ./scripts/build_mac.dart --env=${BUILD_ENV} --package=${PACKAGE_NAME}

      - name: å‡†å¤‡æž„å»ºäº§ç‰©ï¼ˆå•åŒ…ï¼‰
        shell: bash
        run: |
          set -euo pipefail
          PACKAGE_DIR="apps/${PACKAGE_NAME}"
          BUILD_OUTPUT_DIR="${PACKAGE_DIR}/build/macos/Build/Products/Release"
          if [ ! -d "$BUILD_OUTPUT_DIR" ]; then
            echo "æœªæ‰¾åˆ°æž„å»ºè¾“å‡ºç›®å½•: $BUILD_OUTPUT_DIR" >&2
            exit 1
          fi
          APP_SOURCE=$(find "$BUILD_OUTPUT_DIR" -maxdepth 1 -type d -name "*.app" | head -n 1)
          if [ -z "$APP_SOURCE" ]; then
            echo "æœªåœ¨ $BUILD_OUTPUT_DIR ä¸­æ‰¾åˆ° .app æ–‡ä»¶" >&2
            ls -al "$BUILD_OUTPUT_DIR"
            exit 1
          fi
          TARGET_DIR="releases/${PACKAGE_NAME}/${MELOS_PACKAGE_VERSION}"
          mkdir -p "$TARGET_DIR"
          TARGET_APP="$TARGET_DIR/${APP_DISPLAY_NAME}-${MELOS_PACKAGE_VERSION}.app"
          rm -rf "$TARGET_APP"
          cp -R "$APP_SOURCE" "$TARGET_APP"
          echo "TARGET_DIR=$TARGET_DIR" >> "$GITHUB_ENV"
          echo "APP_PATH=$TARGET_APP" >> "$GITHUB_ENV"
          echo "å·²å¤åˆ¶åº”ç”¨åˆ°: $TARGET_APP"

      - name: è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿç»“æž„
        shell: bash
        run: |
          echo "=== è°ƒè¯•æ–‡ä»¶ç³»ç»Ÿç»“æž„ ==="
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "PACKAGE_NAME: ${PACKAGE_NAME}"
          echo ""
          echo "=== æ£€æŸ¥ apps ç›®å½• ==="
          ls -la apps/ || echo "apps ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== æ£€æŸ¥å…·ä½“åº”ç”¨ç›®å½• ==="
          ls -la "apps/${PACKAGE_NAME}/" || echo "åº”ç”¨ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== æ£€æŸ¥ macOS ç›®å½• ==="
          ls -la "apps/${PACKAGE_NAME}/macos/" || echo "macOS ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== æ£€æŸ¥ Runner ç›®å½• ==="
          ls -la "apps/${PACKAGE_NAME}/macos/Runner/" || echo "Runner ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "=== æ£€æŸ¥æƒé™æ–‡ä»¶ ==="
          find "apps/${PACKAGE_NAME}/macos/Runner/" -name "*.entitlements" -type f || echo "æœªæ‰¾åˆ°æƒé™æ–‡ä»¶"

      - name: ä»£ç ç­¾å .appï¼ˆå•åŒ…ï¼‰
        shell: bash
        env:
          MAC_SIGNING_IDENTITY: ${{ env.MAC_SIGNING_IDENTITY }}
          MAC_SIGNING_ENTITLEMENTS: ${{ secrets.MAC_SIGNING_ENTITLEMENTS_PATH }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
        run: |
          set -euo pipefail
          
          if [ -z "${MAC_SIGNING_IDENTITY}" ]; then
            echo "é”™è¯¯: æœªé…ç½®ç­¾åæ ‡è¯† MAC_SIGNING_IDENTITY" >&2
            exit 1
          fi
          
          # è®¾ç½®é»˜è®¤é’¥åŒ™ä¸²
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "${MAC_KEYCHAIN_PASSWORD}" "$KEYCHAIN_PATH"
          
          # ç­¾åå•ä¸ªåº”ç”¨çš„å‡½æ•°
          sign_app() {
            local package="$1"
            local app_path="$2"
            
            echo "å¼€å§‹ç­¾å $package åº”ç”¨: $app_path"
            
            # æŸ¥æ‰¾æƒé™æ–‡ä»¶
            local entitlements_path="${MAC_SIGNING_ENTITLEMENTS:-apps/${package}/macos/Runner/Release.entitlements}"
            if [ ! -f "$entitlements_path" ]; then
              echo "è­¦å‘Š: æœªæ‰¾åˆ°æƒé™æ–‡ä»¶: $entitlements_path"
              echo "å°è¯•æŸ¥æ‰¾å…¶ä»–æƒé™æ–‡ä»¶..."
              # å°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„æƒé™æ–‡ä»¶
              local alternative_paths=(
                "apps/${package}/macos/Runner/DebugProfile.entitlements"
                "apps/${package}/macos/Runner/Release.entitlements"
              )
              
              for alt_path in "${alternative_paths[@]}"; do
                if [ -f "$alt_path" ]; then
                  entitlements_path="$alt_path"
                  echo "æ‰¾åˆ°æƒé™æ–‡ä»¶: $entitlements_path"
                  break
                fi
              done
              
              if [ ! -f "$entitlements_path" ]; then
                echo "è­¦å‘Š: æœªæ‰¾åˆ°ä»»ä½•æƒé™æ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤æƒé™"
                entitlements_path=""
              fi
            fi
            
            echo "ä½¿ç”¨ç­¾åèº«ä»½: ${MAC_SIGNING_IDENTITY}"
            echo "æƒé™æ–‡ä»¶: ${entitlements_path:-æ— }"
            
            # ç­¾åå†…éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆåŒ…æ‹¬ Sparkle æ¡†æž¶å†…çš„ç»„ä»¶ï¼‰
            echo "ç­¾åå†…éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶..."
            
            # 1. ç­¾åæ‰€æœ‰ .dylib, .so, .metallib æ–‡ä»¶
            if find "${app_path}" -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.metallib" \) -print0 | grep -q .; then
              find "${app_path}" -type f \( -name "*.dylib" -o -name "*.so" -o -name "*.metallib" \) -print0 | while IFS= read -r -d '' ITEM; do
                echo "ç­¾ååº“æ–‡ä»¶: $ITEM"
                codesign --force --timestamp --options runtime --sign "$MAC_SIGNING_IDENTITY" "$ITEM"
              done
            else
              echo "æœªæ‰¾åˆ°éœ€è¦ç­¾åçš„åº“æ–‡ä»¶"
            fi
            
            # 2. ç­¾åæ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆåŒ…æ‹¬ Sparkle æ¡†æž¶å†…çš„ Updater, Autoupdate ç­‰ï¼‰
            echo "ç­¾åå¯æ‰§è¡Œæ–‡ä»¶..."
            find "${app_path}" -type f -perm +111 -exec file {} \; | grep -E "(Mach-O|executable)" | cut -d: -f1 | while read -r binary; do
              if [ -f "$binary" ]; then
                echo "ç­¾åå¯æ‰§è¡Œæ–‡ä»¶: $binary"
                codesign --force --timestamp --options runtime --sign "$MAC_SIGNING_IDENTITY" "$binary"
              fi
            done
            
            # 3. ç­¾åæ‰€æœ‰ .app åŒ…ï¼ˆåŒ…æ‹¬åµŒå¥—çš„ï¼Œå¦‚ Sparkle çš„ Updater.appï¼‰
            echo "ç­¾ååº”ç”¨åŒ…..."
            find "${app_path}" -name "*.app" -type d | while read -r app_bundle; do
              echo "ç­¾ååº”ç”¨åŒ…: $app_bundle"
              codesign --force --timestamp --options runtime --sign "$MAC_SIGNING_IDENTITY" "$app_bundle"
            done
            
            # 4. ç­¾åæ‰€æœ‰ .xpc æœåŠ¡ï¼ˆSparkle çš„ XPC æœåŠ¡ï¼‰
            echo "ç­¾å XPC æœåŠ¡..."
            find "${app_path}" -name "*.xpc" -type d | while read -r xpc_bundle; do
              echo "ç­¾å XPC æœåŠ¡: $xpc_bundle"
              codesign --force --timestamp --options runtime --sign "$MAC_SIGNING_IDENTITY" "$xpc_bundle"
            done
            
            # 5. ç­¾åæ‰€æœ‰æ¡†æž¶ï¼ˆåŒ…æ‹¬ Sparkle.frameworkï¼‰
            echo "ç­¾åæ¡†æž¶..."
            if find "${app_path}" -type d -name "*.framework" -print0 | grep -q .; then
              find "${app_path}" -type d -name "*.framework" -print0 | while IFS= read -r -d '' FW; do
                echo "ç­¾åæ¡†æž¶: $FW"
                codesign --force --timestamp --options runtime --sign "$MAC_SIGNING_IDENTITY" "$FW"
              done
            else
              echo "æœªæ‰¾åˆ°éœ€è¦ç­¾åçš„æ¡†æž¶"
            fi
            
            # 6. æœ€åŽç­¾åä¸»åº”ç”¨åŒ…
            echo "ç­¾åä¸»åº”ç”¨..."
            if [ -n "$entitlements_path" ] && [ -f "$entitlements_path" ]; then
              echo "ä½¿ç”¨æƒé™æ–‡ä»¶: $entitlements_path"
              codesign --force --timestamp --options runtime --entitlements "$entitlements_path" --sign "$MAC_SIGNING_IDENTITY" "$app_path"
            else
              echo "ä¸ä½¿ç”¨æƒé™æ–‡ä»¶è¿›è¡Œç­¾å"
              codesign --force --timestamp --options runtime --sign "$MAC_SIGNING_IDENTITY" "$app_path"
            fi
            
            # éªŒè¯ç­¾å
            echo "éªŒè¯ç­¾å..."
            codesign --verify --deep --strict "$app_path"
            
            echo "$package åº”ç”¨ç­¾åå®Œæˆ!"
          }
          
          echo "ç­¾åå•ä¸ªåº”ç”¨: $PACKAGE_NAME"
          sign_app "$PACKAGE_NAME" "$APP_PATH"

      - name: åˆ›å»º DMGï¼ˆå•åŒ…ï¼‰
        shell: bash
        run: |
          set -euo pipefail
          DMG_PATH="${TARGET_DIR}/${APP_DISPLAY_NAME}-${MELOS_PACKAGE_VERSION}.dmg"
          rm -f "$DMG_PATH"
          hdiutil create -volname "${APP_DISPLAY_NAME}" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_PATH"
          echo "DMG_PATH=$DMG_PATH" >> "$GITHUB_ENV"
          echo "å·²ç”Ÿæˆ DMG: $DMG_PATH"

      - name: ç­¾å DMGï¼ˆå•åŒ…ï¼‰
        shell: bash
        env:
          MAC_SIGNING_IDENTITY: ${{ env.MAC_SIGNING_IDENTITY }}
          KEYCHAIN_PATH: ${{ env.KEYCHAIN_PATH }}
        run: |
          set -euo pipefail
          
          if [ -z "${MAC_SIGNING_IDENTITY}" ]; then
            echo "æœªé…ç½®ç­¾åæ ‡è¯† MAC_SIGNING_IDENTITY" >&2
            exit 1
          fi
          
          # è®¾ç½®é»˜è®¤é’¥åŒ™ä¸²
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "${MAC_KEYCHAIN_PASSWORD}" "$KEYCHAIN_PATH"
          
          echo "å¼€å§‹ç­¾å $PACKAGE_NAME DMG: $DMG_PATH"
          echo "ä½¿ç”¨ç­¾åèº«ä»½: ${MAC_SIGNING_IDENTITY}"
          
          # ç­¾å DMG
          codesign --force --sign "$MAC_SIGNING_IDENTITY" "$DMG_PATH"
          
          echo "éªŒè¯ $PACKAGE_NAME DMG ç­¾å..."
          codesign --verify "$DMG_PATH"
          
          echo ""
          echo "$PACKAGE_NAME DMG ç­¾åä¿¡æ¯:"
          codesign -dvv "$DMG_PATH" 2>&1 | head -20 || true

      - name: åˆ¤æ–­æ˜¯å¦éœ€è¦å…¬è¯
        id: notarize_flag
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          if [ -n "${APPLE_ID}" ] && [ -n "${APPLE_APP_SPECIFIC_PASSWORD}" ] && [ -n "${APPLE_TEAM_ID}" ]; then
            echo "APPLE_NOTARIZE=true" >> "$GITHUB_ENV"
            echo "need_notarize=true" >> "$GITHUB_OUTPUT"
          else
            echo "APPLE_NOTARIZE=false" >> "$GITHUB_ENV"
            echo "need_notarize=false" >> "$GITHUB_OUTPUT"
          fi

      - name: å…¬è¯ DMG (å¯é€‰)
        if: ${{ env.APPLE_NOTARIZE == 'true' }}
        continue-on-error: true
        shell: bash
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set +e  # å…è®¸é”™è¯¯ç»§ç»­
          
          echo "å¼€å§‹å…¬è¯ DMG..."
          echo "Apple ID: ${APPLE_ID}"
          echo "Team ID: ${APPLE_TEAM_ID}"
          
          # æ£€æŸ¥å‡­æ®æ˜¯å¦æœ‰æ•ˆ
          if [ -z "${APPLE_ID}" ] || [ -z "${APPLE_APP_SPECIFIC_PASSWORD}" ] || [ -z "${APPLE_TEAM_ID}" ]; then
            echo "è­¦å‘Š: Apple å…¬è¯å‡­æ®ä¸å®Œæ•´ï¼Œè·³è¿‡å…¬è¯"
            echo "å¦‚éœ€å…¬è¯ï¼Œè¯·é…ç½®ä»¥ä¸‹ Secrets:"
            echo "- APPLE_ID: Apple ID é‚®ç®±"
            echo "- APPLE_APP_SPECIFIC_PASSWORD: App ä¸“ç”¨å¯†ç "
            echo "- APPLE_TEAM_ID: Apple å¼€å‘è€…å›¢é˜Ÿ ID"
            exit 0
          fi
          
          # æäº¤å…¬è¯
          echo "æ­£åœ¨æäº¤å…¬è¯è¯·æ±‚..."
          xcrun notarytool submit "$DMG_PATH" --wait --apple-id "$APPLE_ID" --password "$APPLE_APP_SPECIFIC_PASSWORD" --team-id "$APPLE_TEAM_ID" > /tmp/notary_output.txt 2>&1
          NOTARIZE_RESULT=$?
          
          # æ£€æŸ¥å…¬è¯ç»“æžœ
          if [ $NOTARIZE_RESULT -eq 0 ]; then
            # æå–å…¬è¯çŠ¶æ€
            NOTARIZE_STATUS=$(grep -i "status:" /tmp/notary_output.txt | tail -1 | awk '{print $NF}')
            
            if [ "$NOTARIZE_STATUS" = "Accepted" ]; then
              echo "âœ… å…¬è¯æˆåŠŸï¼çŠ¶æ€: $NOTARIZE_STATUS"
              # é’‰ä½å…¬è¯ç¥¨æ®
              echo "æ­£åœ¨é’‰ä½å…¬è¯ç¥¨æ®..."
              xcrun stapler staple "$DMG_PATH"
              STAPLE_RESULT=$?
              
              if [ $STAPLE_RESULT -eq 0 ]; then
                echo "âœ… å·²æˆåŠŸé’‰ä½å…¬è¯ç¥¨æ®"
              else
                echo "âš ï¸ é’‰ä½å…¬è¯ç¥¨æ®å¤±è´¥ï¼ˆé€€å‡ºä»£ç : $STAPLE_RESULTï¼‰"
                echo "åº”ç”¨å·²å…¬è¯ï¼Œä½†æœªé’‰ä½ç¥¨æ®"
              fi
            else
              echo "âŒ å…¬è¯è¢«æ‹’ç»æˆ–å¤±è´¥"
              echo "å…¬è¯çŠ¶æ€: $NOTARIZE_STATUS"
              echo "å®Œæ•´è¾“å‡º:"
              cat /tmp/notary_output.txt
              
              # æå–æäº¤ ID å¹¶æŸ¥è¯¢è¯¦ç»†æ—¥å¿—
              SUBMISSION_ID=$(grep "id:" /tmp/notary_output.txt | head -1 | awk '{print $2}')
              if [ -n "$SUBMISSION_ID" ]; then
                echo ""
                echo "==========================================="
                echo "æŸ¥è¯¢è¯¦ç»†å…¬è¯æ—¥å¿— (Submission ID: $SUBMISSION_ID)"
                echo "==========================================="
                xcrun notarytool log "$SUBMISSION_ID" --apple-id "$APPLE_ID" --password "$APPLE_APP_SPECIFIC_PASSWORD" --team-id "$APPLE_TEAM_ID" || true
                echo "==========================================="
              fi
              
              echo ""
              echo "åº”ç”¨å·²æž„å»ºå¹¶ç­¾åï¼Œä½†æœªé€šè¿‡ Apple å…¬è¯"
              echo "æœªå…¬è¯çš„åº”ç”¨ä»å¯è¿è¡Œï¼Œä½†é¦–æ¬¡å¯åŠ¨æ—¶éœ€è¦ç”¨æˆ·ä¿¡ä»»"
            fi
          else
            echo "âŒ å…¬è¯æäº¤å¤±è´¥ï¼ˆé€€å‡ºä»£ç : $NOTARIZE_RESULTï¼‰"
            echo "å®Œæ•´è¾“å‡º:"
            cat /tmp/notary_output.txt
            echo ""
            echo "è¿™å¯èƒ½æ˜¯ç”±äºŽï¼š"
            echo "1. App ä¸“ç”¨å¯†ç æ— æ•ˆ"
            echo "2. Apple ID æˆ– Team ID é”™è¯¯"
            echo "3. ç½‘ç»œé—®é¢˜"
            echo "4. DMG ç­¾åé—®é¢˜"
            echo ""
            echo "åº”ç”¨å·²æž„å»ºå¹¶ç­¾åï¼Œä½†ä¸åŒ…å« Apple å…¬è¯"
            echo "æœªå…¬è¯çš„åº”ç”¨ä»å¯è¿è¡Œï¼Œä½†é¦–æ¬¡å¯åŠ¨æ—¶éœ€è¦ç”¨æˆ·ä¿¡ä»»"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/notary_output.txt

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©ï¼ˆå•åŒ…ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ env.PACKAGE_NAME }}-${{ env.MELOS_PACKAGE_VERSION }}
          path: ${{ env.DMG_PATH }}
          if-no-files-found: error

      - name: ä¸Šä¼ åˆ° Google Cloud Storage
        if: ${{ env.UPLOAD_TO_STORAGE == 'true' }}
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.GOOGLE_STORAGE_CREDENTIALS }}"

      - name: ä¸Šä¼  DMG åˆ°å­˜å‚¨æ¡¶ï¼ˆå•åŒ…ï¼‰
        if: ${{ env.UPLOAD_TO_STORAGE == 'true' }}
        id: "upload-storage"
        uses: "google-github-actions/upload-cloud-storage@v2"
        with:
          path: ${{ env.DMG_PATH }}
          destination: ${{ env[format('{0}_path', env.PACKAGE_NAME)] }}
          parent: false

      - name: ä¸Šä¼ åˆ° Web æœåŠ¡å™¨ï¼ˆå•åŒ…ï¼‰
        if: ${{ env.UPLOAD_TO_WEB == 'true' }}
        uses: Comori/ssh@v0.0.7
        with:
          host: ${{ secrets.SCP_S_HOST }}
          username: ${{ secrets.SCP_S_USER }}
          privateKey: ${{ secrets.SCP_S_RIVATEKEY }}
          command: |
            echo "ä¸Šä¼  $PACKAGE_NAME DMG åˆ°æœåŠ¡å™¨..."
            scp ${{ env[format('scp_s_{0}', env.PACKAGE_NAME)] }}${{ env.VERSION_DMG }}  "${{ secrets.SCP_D_USER }}@${{ secrets.SCP_D_HOST }}:${{ env[format('scp_d_{0}', env.PACKAGE_NAME)] }}"

            # 2. åœ¨æœ€ç»ˆæœåŠ¡å™¨åˆ›å»ºè½¯é“¾
            if [ -n "${{ env.LATEST_NAME }}" ] && [ -n "${{ env.VERSION_DMG }}" ]; then
                ssh -o StrictHostKeyChecking=no ${{secrets.SCP_D_USER }}@${{ secrets.SCP_D_HOST }} "cd ${{ env[format('scp_s_{0}', env.PACKAGE_NAME)] }} && ln -sf ${{ env.VERSION_DMG }} ${{ env.LATEST_NAME }}"
                echo "Created symlink: ${{ env.LATEST_NAME }} -> ${{ env.VERSION_DMG }}"
            fi
          sourceFiles: |
            ${{ env.DMG_PATH }}
          targetDir: ${{ env[format('scp_s_{0}', env.PACKAGE_NAME)] }}
          scpFirst: true

  build-all:
    if: github.event.inputs.build_type == 'all'
    runs-on: macos-latest
    strategy:
      matrix:
        pkg: [pos, assistant, kds, tablet]
      fail-fast: false
    env:
      PACKAGE_NAME: ${{ matrix.pkg }}
      BUILD_ENV: ${{ github.event.inputs.env }}
      BRANCH_NAME: ${{ github.event.inputs.branch }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      MAC_KEYCHAIN_PASSWORD: ${{ secrets.MAC_KEYCHAIN_PASSWORD }}
      UPLOAD_TO_STORAGE: ${{ github.event.inputs.upload_to_storage }}
      UPLOAD_TO_WEB: ${{ github.event.inputs.upload_to_web }}
      assistant_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Assistant/' || 'dc_apk/TTPOS/Test/MacOS/Assistant/' }}
      kds_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Kitchen/' || 'dc_apk/TTPOS/Test/MacOS/Kitchen/' }}
      tablet_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Menu/' || 'dc_apk/TTPOS/Test/MacOS/Menu/' }}
      pos_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Cashier/' || 'dc_apk/TTPOS/Test/MacOS/Cashier/' }}
      shop_path: ${{ github.event.inputs.branch == 'release' && 'dc_apk/TTPOS/Prod/MacOS/Shop/' || 'dc_apk/TTPOS/Test/MacOS/Shop/' }}
      scp_s_assistant: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/assistant/' || '/hitosea/ttpos-apk/Test/assistant/' }}
      scp_s_kds: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/kds/' || '/hitosea/ttpos-apk/Test/kds/' }}
      scp_s_tablet: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/tablet/' || '/hitosea/ttpos-apk/Test/tablet/' }}
      scp_s_pos: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/pos/' || '/hitosea/ttpos-apk/Test/pos/' }}
      scp_s_shop: ${{ github.event.inputs.branch == 'release' && '/hitosea/ttpos-apk/Prod/shop/' || '/hitosea/ttpos-apk/Test/shop/' }}
      scp_d_assistant: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Assistant/' || '/root/web/web/restant/out/downloads/MacOS/Assistant/' }}
      scp_d_kds: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Kitchen/' || '/root/web/web/restant/out/downloads/MacOS/Kitchen/' }}
      scp_d_tablet: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Menu/' || '/root/web/web/restant/out/downloads/MacOS/Menu/' }}
      scp_d_pos: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Cashier/' || '/root/web/web/restant/out/downloads/MacOS/Cashier/' }}
      scp_d_shop: ${{ github.event.inputs.branch == 'release' && '/root/web/web/restant/out/downloads/MacOS/Shop/' || '/root/web/web/restant/out/downloads/MacOS/Shop/' }}
    steps: *mac_steps
